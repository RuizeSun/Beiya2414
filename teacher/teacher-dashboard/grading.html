<!doctype html>
<html lang="zh-TW">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>教师批改系统 (含 AI 辅助与绘图)</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			.no-scrollbar::-webkit-scrollbar {
				display: none;
			}
			.no-scrollbar {
				-ms-overflow-style: none;
				scrollbar-width: none;
			}
			.modal-active {
				overflow: hidden;
			}
			#canvas-container {
				position: relative;
				display: inline-block;
				line-height: 0;
			}
			#grading-canvas {
				position: absolute;
				top: 0;
				left: 0;
				touch-action: none;
				cursor: crosshair;
			}
			.loading-overlay {
				position: absolute;
				inset: 0;
				background: rgba(255, 255, 255, 0.7);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 50;
			}
		</style>
	</head>
	<body class="bg-gray-100 h-screen flex flex-col font-sans">
		<header class="bg-white shadow-md z-10 p-4 border-b">
			<div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
				<h1 class="text-xl font-bold text-gray-800">作业批改管理</h1>
				<div class="flex flex-wrap items-center gap-2">
					<input type="text" id="searchName" placeholder="搜寻学生姓名..." class="border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 outline-none" />
					<input type="date" id="searchDate" class="border rounded px-3 py-2 text-sm outline-none" />
					<select id="statusFilter" class="border rounded px-3 py-2 text-sm outline-none">
						<option value="all">全部状态</option>
						<option value="ungraded">未批改</option>
						<option value="graded">已批改</option>
					</select>

					<select id="homeworkSelect" class="border rounded px-3 py-2 text-sm outline-none">
						<option value="0">全部作业（本学科）</option>
					</select>

					<!-- 批量AI批改配置（模型 + Prompt） -->
					<select id="batchAiModelSelect" class="border rounded px-3 py-2 text-sm outline-none min-w-[160px]">
						<option value="">载入模型中...</option>
					</select>
					<input id="batchPrompt" class="border rounded px-3 py-2 text-sm outline-none w-72" placeholder="批量批改 Prompt（可选，例如：按语法/结构/逻辑评分，并给改进建议）" />

					<label class="inline-flex items-center gap-2 text-sm text-gray-600 select-none">
						<input id="selectAllBox" type="checkbox" class="w-4 h-4" onchange="toggleSelectAll(this.checked)" />
						全选
					</label>

					<button onclick="batchAICorrectSelected()" class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700 transition">批量AI批改（已选）</button>
					<button onclick="batchAICorrectByHomework()" class="bg-purple-50 text-purple-700 border border-purple-200 px-4 py-2 rounded text-sm hover:bg-purple-100 transition">批量AI批改（整份作业）</button>

					<span id="batchProgress" class="text-xs text-gray-600 hidden"></span>

					<button onclick="fetchList()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition">筛选</button>
				</div>
			</div>
		</header>

		<main class="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar">
			<div class="max-w-7xl mx-auto">
				<div id="homework-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
					<!-- 动态载入 -->
				</div>
			</div>
		</main>

		<div id="gradeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
			<div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] flex flex-col overflow-hidden relative">
				<div class="p-4 border-b flex justify-between items-center bg-gray-50">
					<div>
						<h2 id="modalTitle" class="text-lg font-bold text-gray-800">批改作业</h2>
						<p id="modalSubTitle" class="text-xs text-gray-500"></p>
					</div>
					<button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl px-2">&times;</button>
				</div>

				<div class="flex-1 overflow-y-auto flex flex-col md:flex-row">
					<div class="flex-1 bg-gray-200 p-4 flex items-center justify-center overflow-auto min-h-[400px]">
						<div id="canvas-container">
							<img id="studentWorkImg" src="" alt="学生作业" class="max-w-full h-auto shadow-lg" />
							<canvas id="grading-canvas"></canvas>
						</div>
					</div>

					<div class="w-full md:w-80 border-l bg-white p-5 flex flex-col gap-4">
						<div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
							<label class="block text-xs font-bold text-blue-700 mb-2">AI 辅助批改</label>
							<select id="aiModelSelect" class="w-full border rounded p-2 text-sm mb-2 outline-none">
								<option value="">载入模型中...</option>
							</select>
							<textarea id="aiInstruction" placeholder="输入 AI 批改指令 (例如：请纠正语法错误并评分)..." class="w-full border rounded p-2 text-xs mb-2 h-16 outline-none"></textarea>
							<button id="aiBtn" onclick="runAIGrade()" class="w-full bg-indigo-600 text-white py-2 rounded text-sm hover:bg-indigo-700">执行 AI 批改</button>
						</div>
						<hr />
						<div>
							<label class="block text-sm font-medium text-gray-700 mb-1">给予评分 (0-100)</label>
							<input type="number" id="gradeScore" min="0" max="100" class="w-full border rounded p-2 text-lg font-bold text-center text-blue-600 outline-none" placeholder="分" />
						</div>
						<div>
							<label class="block text-sm font-medium text-gray-700 mb-1">评语内容</label>
							<textarea id="gradeContent" class="w-full border rounded p-2 text-sm h-32 outline-none" placeholder="请输入给学生的评语..."></textarea>
						</div>
						<div class="mt-auto flex flex-col gap-2">
							<button onclick="clearCanvas()" class="w-full border border-gray-300 text-gray-600 py-2 rounded text-sm hover:bg-gray-50">清除画布</button>
							<button id="submitBtn" onclick="submitGrade()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">确认并保存批改</button>
						</div>
					</div>
				</div>
				<div id="aiLoading" class="loading-overlay hidden">
					<div class="text-center">
						<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-2"></div>
						<p class="text-sm text-gray-600 font-medium">AI 正在阅卷并分析图片...</p>
					</div>
				</div>
			</div>
		</div>

		<script>
			const API = "/system/teacher-grading.php";
			let currentId = null;
			let currentHomeworkData = null;

			let currentHomeworkItems = [];
			let currentSubmissionItems = [];
			let selectedSet = new Set();
			let _visionAlerted = false;

			const canvas = document.getElementById("grading-canvas");
			const ctx = canvas.getContext("2d");
			const img = document.getElementById("studentWorkImg");
			let isDrawing = false;

			window.onload = () => {
				fetchHomeworkList();
				fetchList();
				fetchAIModels();
				initCanvas();
			};

			async function fetchHomeworkList() {
				try {
					const res = await fetch(`${API}?action=homework_list`);
					const json = await res.json();
					const select = document.getElementById("homeworkSelect");
					if (!select) return;
					// 保留第一个“全部作业”选项
					select.innerHTML = `<option value="0">全部作业（本学科）</option>`;
					if (json.status === "success") {
						currentHomeworkItems = json.data || [];
						const selAll = document.getElementById("selectAllBox");
						if (selAll) selAll.checked = false;
						json.data.forEach((h) => {
							const opt = document.createElement("option");
							opt.value = h.homework_id;
							const timeRange = h.releasetime ? `（${h.releasetime}${h.stoptime ? " ~ " + h.stoptime : ""}）` : "";
							opt.textContent = `${h.title || "未命名作业"} - ${h.creator_name || ""}${timeRange}`;
							select.appendChild(opt);
							if (batchSelect) batchSelect.appendChild(opt.cloneNode(true));
						});
					}
					// 改变作业选择时自动刷新列表
					select.onchange = () => fetchList();
				} catch (e) {
					console.warn("fetchHomeworkList failed", e);
				}
			}

			function toggleSelectAll(checked) {
				const all = Array.from(document.querySelectorAll(".submissionCheck"));
				const selectAll = document.getElementById("selectAllBox");
				// 同步 UI
				all.forEach((cb) => (cb.checked = checked));
				if (selectAll) selectAll.checked = !!checked;

				// 同步状态集合
				selectedSet.clear();
				if (checked) {
					all.forEach((cb) => {
						const id = cb.getAttribute("data-submission-id");
						if (id) selectedSet.add(String(id));
					});
				}
			}

			function syncSelectAllState() {
				const all = Array.from(document.querySelectorAll(".submissionCheck"));
				const selectAll = document.getElementById("selectAllBox");
				if (!all.length) {
					if (selectAll) selectAll.checked = false;
					return;
				}
				const checked = all.filter((cb) => cb.checked).length;
				if (selectAll) selectAll.checked = checked === all.length;
			}

			function onSubmissionCheckChange(cb) {
				const id = cb.getAttribute("data-submission-id");
				if (!id) return;
				if (cb.checked) selectedSet.add(String(id));
				else selectedSet.delete(String(id));
				syncSelectAllState();
			}

			function getSelectedSubmissionIds() {
				return Array.from(selectedSet);
			}

			function buildGradePrompt(homeworkTitle, userInstruction) {
				return `你是一位专业的老师。
作业题目：${homeworkTitle || ""}
老师的要求：${userInstruction || "请对作业进行评分并提供具体建议。"}
请分析图片中的内容，直接返回 JSON 格式，包含 score (0-100) 和 comment (点评)。
点评需要简洁，控制在50字以内，不需要描述学生作业的内容，只需描述作业的不足之处。
满足老师要求的且质量优秀的打100分，完全不满足老师要求的打0分（未提交对应照片、未完成等）。`;
			}

			function handleVisionModelError(msg) {
				const s = String(msg || "");
				// 典型：AI 供应商错误: No endpoints found that support image input
				const isVisionError = /No endpoints found that support image input/i.test(s) || /support image input/i.test(s) || /no endpoints.*image/i.test(s) || (/vision/i.test(s) && /image/i.test(s));
				if (isVisionError) {
					if (!_visionAlerted) {
						alert("当前模型无视觉功能，无法处理作业图片。请在模型列表中选择带视觉功能（VL）的模型后重试。");
						_visionAlerted = true;
					}
					return true;
				}
				return false;
			}

			async function batchAICorrectSelected() {
				const modelAlias = document.getElementById("batchAiModelSelect")?.value;
				const userInstruction = document.getElementById("batchPrompt")?.value?.trim() || "";
				if (!modelAlias) {
					alert("请先选择批量批改模型");
					return;
				}

				const selectedIds = getSelectedSubmissionIds();
				if (!selectedIds.length) {
					alert("请先勾选要批改的提交（可用“全选”）");
					return;
				}

				// 从当前列表中取出对应 item，拿到 student_image 等信息
				const idSet = new Set(selectedIds.map(String));
				const items = (currentSubmissionItems || []).filter((it) => idSet.has(String(it.submission_id)));

				if (!items.length) {
					alert("未找到已选提交的数据，请先点击“筛选”刷新列表");
					return;
				}

				await runBatchAI(items, modelAlias, userInstruction);
				await fetchList();
			}

			async function runBatchAI(items, modelAlias, userInstruction) {
				const progress = document.getElementById("batchProgress");
				progress.classList.remove("hidden");

				_visionAlerted = false;

				let done = 0,
					ok = 0,
					fail = 0;

				let stopBecauseNoVision = false;

				for (const item of items) {
					done++;
					progress.textContent = `批量批改中：${done}/${items.length}（成功 ${ok}，失败 ${fail}）...`;

					try {
						// 1) AI 批改
						const aiRes = await fetch(`${API}?action=ai_grade`, {
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify({
								submission_id: item.submission_id,
								model_alias: modelAlias,
								prompt: buildGradePrompt(item.homework_title, userInstruction),
								student_image: item.student_image,
							}),
						});
						const aiJson = await aiRes.json();
						if (aiJson.status !== "success") {
							// 如果是模型不支持图片输入，提示并终止批量
							if (handleVisionModelError(aiJson.message || aiJson.data)) {
								stopBecauseNoVision = true;
								throw new Error(aiJson.message || "所选模型无视觉功能");
							}
							throw new Error(aiJson.message || "AI 批改失败");
						}

						// 2) 解析 AI 输出（尽量兼容：JSON / 文本中包含 JSON）
						let parsed = null;
						try {
							parsed = JSON.parse(aiJson.data);
						} catch (e) {
							const m = String(aiJson.data).match(/\{[\s\S]*\}/);
							if (m) parsed = JSON.parse(m[0]);
						}
						if (!parsed) throw new Error("AI 输出无法解析为 JSON（请让模型输出 JSON：{score, comment}）");

						const score = parsed.score ?? parsed.Score ?? parsed.points ?? null;
						const comment = parsed.comment ?? parsed.Comment ?? parsed.feedback ?? parsed.reason ?? "";

						if (score === null || score === undefined) throw new Error("AI 输出缺少 score 字段");

						// 3) 保存批改结果
						const saveRes = await fetch(`${API}?action=submit_grade`, {
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify({
								submission_id: item.submission_id,
								score: score,
								comment: comment,
							}),
						});
						const saveJson = await saveRes.json();
						if (saveJson.status !== "success") throw new Error(saveJson.message || "保存失败");

						ok++;
					} catch (err) {
						console.error("Batch item failed", item, err);
						// 若检测到无视觉功能，给出明确提示并停止继续请求
						if (handleVisionModelError(err && err.message)) {
							stopBecauseNoVision = true;
							break;
						}
						fail++;
					}
				}

				progress.textContent = stopBecauseNoVision ? `批量批改已停止：当前所选模型无视觉功能（不支持图片输入）。请改用带视觉（VL）的模型后重试。` : `批量批改完成：共 ${items.length}，成功 ${ok}，失败 ${fail}`;
				setTimeout(() => progress.classList.add("hidden"), 2500);
			}

			async function batchAICorrectByHomework() {
				const homeworkId = document.getElementById("homeworkSelect").value || 0;
				if (String(homeworkId) === "0") {
					alert("请先在下拉框选择一个具体作业，才能批量AI批改。");
					return;
				}
				const status = document.getElementById("statusFilter").value || "all";
				const modelAlias = document.getElementById("batchAiModelSelect")?.value;
				const userInstruction = document.getElementById("batchPrompt")?.value?.trim() || "";

				if (!modelAlias) {
					alert("请先在顶部选择批量批改模型。");
					return;
				}

				const progress = document.getElementById("batchProgress");
				progress.classList.remove("hidden");

				_visionAlerted = false;
				progress.textContent = "正在获取批量范围...";

				try {
					const res = await fetch(`${API}?action=batch_scope&homework_id=${homeworkId}&status=${status}`);
					const json = await res.json();
					if (json.status !== "success") {
						progress.classList.add("hidden");
						alert(json.message || "获取批量范围失败");
						return;
					}

					const items = json.data.items || [];
					if (items.length === 0) {
						progress.classList.add("hidden");
						alert("该作业暂无符合条件的提交。");
						return;
					}

					await runBatchAI(items, modelAlias, userInstruction);
					await fetchList();
				} catch (e) {
					progress.classList.add("hidden");
					alert("批量批改异常：" + (e?.message || e));
				}
			}

			async function fetchList() {
				const name = document.getElementById("searchName").value;
				const date = document.getElementById("searchDate").value;
				const status = document.getElementById("statusFilter").value;

				// 刷新列表时重置“全选/已选”状态，避免出现“全选仍勾选但列表未选中”的错觉
				selectedSet.clear();
				const selectAll = document.getElementById("selectAllBox");
				if (selectAll) selectAll.checked = false;

				try {
					const homeworkId = document.getElementById("homeworkSelect").value || 0;
					const res = await fetch(`${API}?action=list&student_name=${encodeURIComponent(name)}&date=${date}&status=${status}&homework_id=${homeworkId}`);
					const json = await res.json();
					const container = document.getElementById("homework-list");
					container.innerHTML = "";

					if (json.status === "success") {
						currentSubmissionItems = json.data || [];

						currentSubmissionItems.forEach((item) => {
							const card = document.createElement("div");
							card.className = "bg-white rounded-xl shadow-sm border p-4 hover:shadow-md transition cursor-pointer relative group";
							card.onclick = () => openModal(item);

							const statusBadge = item.score !== null ? `<span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full font-bold">已批改 ${item.score}分</span>` : `<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded-full font-bold">待批改</span>`;

							const displayName = item.student_name || `${item.lastname}${item.firstname}`;
							const isChecked = selectedSet.has(String(item.submission_id));

							card.innerHTML = `
								<div class="absolute top-3 left-3 z-10" onclick="event.stopPropagation()">
									<input type="checkbox" class="submissionCheck w-4 h-4" data-submission-id="${item.submission_id}" ${isChecked ? "checked" : ""} onchange="onSubmissionCheckChange(this)" />
								</div>

								<div class="aspect-video bg-gray-100 rounded-lg mb-3 overflow-hidden border">
									<img src="${item.student_image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x300?text=No+Image'">
								</div>
								<div class="flex justify-between items-start mb-1">
									<h3 class="font-bold text-gray-800 truncate flex-1">${displayName}</h3>
									${statusBadge}
								</div>
								<p class="text-xs text-gray-500 truncate">${item.homework_title}</p>
								<p class="text-[10px] text-gray-400 mt-2">${item.submit_time}</p>
							`;
							container.appendChild(card);
						});
					}
				} catch (e) {
					console.error(e);
				}
			}

			async function fetchAIModels() {
				try {
					const res = await fetch(`${API}?action=get_ai_models`);
					const json = await res.json();
					const select = document.getElementById("aiModelSelect");
					const batchSelect = document.getElementById("batchAiModelSelect");
					select.innerHTML = "";
					if (batchSelect) batchSelect.innerHTML = "";
					if (json.status === "success" && json.data.length > 0) {
						json.data.forEach((m) => {
							const opt = document.createElement("option");
							opt.value = m.model_alias;
							opt.innerText = m.model_name;
							select.appendChild(opt);
							if (batchSelect) batchSelect.appendChild(opt.cloneNode(true));
						});
					} else {
						select.innerHTML = '<option value="">未授权 AI 模型</option>';
					}
				} catch (e) {
					console.error(e);
				}
			}

			function openModal(data) {
				currentId = data.submission_id;
				currentHomeworkData = data;
				const displayName = data.student_name || `${data.lastname}${data.firstname}`;
				document.getElementById("modalTitle").innerText = `${displayName} 的作业`;
				document.getElementById("modalSubTitle").innerText = data.homework_title;
				document.getElementById("gradeScore").value = data.score !== null ? data.score : "";
				document.getElementById("gradeContent").value = data.comment || data.content || "";
				img.src = data.student_image;
				document.getElementById("gradeModal").classList.remove("hidden");
				document.body.classList.add("modal-active");
				img.onload = () => {
					canvas.width = img.clientWidth;
					canvas.height = img.clientHeight;
					clearCanvas();
				};
			}

			function closeModal() {
				document.getElementById("gradeModal").classList.add("hidden");
				document.body.classList.remove("modal-active");
			}

			function initCanvas() {
				const getPos = (e) => {
					const rect = canvas.getBoundingClientRect();
					const clientX = e.touches ? e.touches[0].clientX : e.clientX;
					const clientY = e.touches ? e.touches[0].clientY : e.clientY;
					return { x: clientX - rect.left, y: clientY - rect.top };
				};
				const start = (e) => {
					isDrawing = true;
					const p = getPos(e);
					ctx.beginPath();
					ctx.moveTo(p.x, p.y);
				};
				const draw = (e) => {
					if (!isDrawing) return;
					const p = getPos(e);
					ctx.lineWidth = 3;
					ctx.lineCap = "round";
					ctx.strokeStyle = "red";
					ctx.lineTo(p.x, p.y);
					ctx.stroke();
				};
				const end = () => {
					isDrawing = false;
				};
				canvas.addEventListener("mousedown", start);
				canvas.addEventListener("mousemove", draw);
				window.addEventListener("mouseup", end);
				canvas.addEventListener("touchstart", (e) => {
					e.preventDefault();
					start(e);
				});
				canvas.addEventListener("touchmove", (e) => {
					e.preventDefault();
					draw(e);
				});
				canvas.addEventListener("touchend", end);
			}

			function clearCanvas() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}

			async function runAIGrade() {
				const modelAlias = document.getElementById("aiModelSelect").value;
				const userInstruction = document.getElementById("aiInstruction").value;
				if (!modelAlias) return alert("请选择 AI 模型");
				const overlay = document.getElementById("aiLoading");
				overlay.classList.remove("hidden");

				_visionAlerted = false;

				// 优化：Prompt 仅保留文字要求，不再嵌入 Base64 数据
				const textPrompt = `你是一位专业的老师。
作业题目：${currentHomeworkData.homework_title}
老师的要求：${userInstruction || "请对作业进行评分并提供具体建议。"}
请分析图片中的内容，直接返回 JSON 格式，包含 score (0-100) 和 comment (点评)。
点评需要简洁，控制在50字以内，不需要描述学生作业的内容，只需描述作业的不足之处。
满足老师要求的且质量优秀的打100分，完全不满足老师要求的打0分（未提交对应照片、未完成等）。`;

				try {
					const res = await fetch(`${API}?action=ai_grade`, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							submission_id: currentId,
							model_alias: modelAlias,
							prompt: textPrompt,
							student_image: currentHomeworkData.student_image, // 图片数据独立传输
						}),
					});
					const json = await res.json();
					if (json.status === "success") {
						let result = json.data;
						if (typeof result === "string") {
							try {
								result = JSON.parse(result.replace(/```json|```/g, ""));
							} catch (e) {}
						}
						console.log(result);
						document.getElementById("gradeScore").value = result.score || "0";
						document.getElementById("gradeContent").value = result.comment || result.content || (typeof result === "string" ? result : "");
					} else {
						if (!handleVisionModelError(json.message || json.data)) {
							alert("AI 失败: " + (json.message || "未知错误"));
						}
					}
				} catch (e) {
					if (!handleVisionModelError(e && e.message)) {
						alert("请求失败");
					}
				}
				overlay.classList.add("hidden");
			}

			async function submitGrade() {
				const score = document.getElementById("gradeScore").value;
				const content = document.getElementById("gradeContent").value;
				const btn = document.getElementById("submitBtn");
				if (score === "") return alert("请输入评分");
				const drawingData = canvas.toDataURL("image/png");
				btn.disabled = true;
				btn.innerText = "保存中...";
				try {
					const res = await fetch(`${API}?action=submit_grade`, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ submission_id: currentId, score: score, content: content, comment: content, check_image: drawingData }),
					});
					const json = await res.json();
					if (json.status === "success") {
						btn.innerText = "保存成功 ✅";
						setTimeout(() => {
							closeModal();
							fetchList();
							btn.disabled = false;
							btn.innerText = "确认并保存批改";
						}, 1000);
					} else {
						alert(json.message);
						btn.disabled = false;
						btn.innerText = "重新尝试";
					}
				} catch (e) {
					alert("网络错误");
					btn.disabled = false;
				}
			}
		</script>
	</body>
</html>
