<!doctype html>
<html lang="zh-TW">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>教师批改系统 (含 AI 辅助与绘图)</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			.no-scrollbar::-webkit-scrollbar {
				display: none;
			}
			.no-scrollbar {
				-ms-overflow-style: none;
				scrollbar-width: none;
			}
			.modal-active {
				overflow: hidden;
			}
			#canvas-container {
				position: relative;
				display: inline-block;
				line-height: 0;
			}
			#grading-canvas {
				position: absolute;
				top: 0;
				left: 0;
				touch-action: none;
				cursor: crosshair;
			}
			.loading-overlay {
				position: absolute;
				inset: 0;
				background: rgba(255, 255, 255, 0.7);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 50;
			}
		</style>
	</head>
	<body class="bg-gray-100 h-screen flex flex-col font-sans">
		<header class="bg-white shadow-md z-10 p-4 border-b">
			<div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
				<h1 class="text-xl font-bold text-gray-800">作业批改管理</h1>
				<div class="flex flex-wrap items-center gap-2">
					<input type="text" id="searchName" placeholder="搜寻学生姓名..." class="border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 outline-none" />
					<input type="date" id="searchDate" class="border rounded px-3 py-2 text-sm outline-none" />
					<select id="statusFilter" class="border rounded px-3 py-2 text-sm outline-none">
						<option value="all">全部状态</option>
						<option value="ungraded">未批改</option>
						<option value="graded">已批改</option>
					</select>
					<button onclick="fetchList()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition">筛选</button>
				</div>
			</div>
		</header>

		<main class="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar">
			<div class="max-w-7xl mx-auto">
				<div id="homework-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
					<!-- 动态载入 -->
				</div>
			</div>
		</main>

		<div id="gradeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
			<div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] flex flex-col overflow-hidden relative">
				<div class="p-4 border-b flex justify-between items-center bg-gray-50">
					<div>
						<h2 id="modalTitle" class="text-lg font-bold text-gray-800">批改作业</h2>
						<p id="modalSubTitle" class="text-xs text-gray-500"></p>
					</div>
					<button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl px-2">&times;</button>
				</div>

				<div class="flex-1 overflow-y-auto flex flex-col md:flex-row">
					<div class="flex-1 bg-gray-200 p-4 flex items-center justify-center overflow-auto min-h-[400px]">
						<div id="canvas-container">
							<img id="studentWorkImg" src="" alt="学生作业" class="max-w-full h-auto shadow-lg" />
							<canvas id="grading-canvas"></canvas>
						</div>
					</div>

					<div class="w-full md:w-80 border-l bg-white p-5 flex flex-col gap-4">
						<div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
							<label class="block text-xs font-bold text-blue-700 mb-2">AI 辅助批改</label>
							<select id="aiModelSelect" class="w-full border rounded p-2 text-sm mb-2 outline-none">
								<option value="">载入模型中...</option>
							</select>
							<textarea id="aiInstruction" placeholder="输入 AI 批改指令 (例如：请纠正语法错误并评分)..." class="w-full border rounded p-2 text-xs mb-2 h-16 outline-none"></textarea>
							<button id="aiBtn" onclick="runAIGrade()" class="w-full bg-indigo-600 text-white py-2 rounded text-sm hover:bg-indigo-700">执行 AI 批改</button>
						</div>
						<hr />
						<div>
							<label class="block text-sm font-medium text-gray-700 mb-1">给予评分 (0-100)</label>
							<input type="number" id="gradeScore" min="0" max="100" class="w-full border rounded p-2 text-lg font-bold text-center text-blue-600 outline-none" placeholder="分" />
						</div>
						<div>
							<label class="block text-sm font-medium text-gray-700 mb-1">评语内容</label>
							<textarea id="gradeContent" class="w-full border rounded p-2 text-sm h-32 outline-none" placeholder="请输入给学生的评语..."></textarea>
						</div>
						<div class="mt-auto flex flex-col gap-2">
							<button onclick="clearCanvas()" class="w-full border border-gray-300 text-gray-600 py-2 rounded text-sm hover:bg-gray-50">清除画布</button>
							<button id="submitBtn" onclick="submitGrade()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">确认并保存批改</button>
						</div>
					</div>
				</div>
				<div id="aiLoading" class="loading-overlay hidden">
					<div class="text-center">
						<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-2"></div>
						<p class="text-sm text-gray-600 font-medium">AI 正在阅卷并分析图片...</p>
					</div>
				</div>
			</div>
		</div>

		<script>
			const API = "/system/teacher-grading.php";
			let currentId = null;
			let currentHomeworkData = null;
			const canvas = document.getElementById("grading-canvas");
			const ctx = canvas.getContext("2d");
			const img = document.getElementById("studentWorkImg");
			let isDrawing = false;

			window.onload = () => {
				fetchList();
				fetchAIModels();
				initCanvas();
			};

			async function fetchList() {
				const name = document.getElementById("searchName").value;
				const date = document.getElementById("searchDate").value;
				const status = document.getElementById("statusFilter").value;
				try {
					const res = await fetch(`${API}?action=list&student_name=${encodeURIComponent(name)}&date=${date}&status=${status}`);
					const json = await res.json();
					const container = document.getElementById("homework-list");
					container.innerHTML = "";
					if (json.status === "success") {
						json.data.forEach((item) => {
							const card = document.createElement("div");
							card.className = "bg-white rounded-xl shadow-sm border p-4 hover:shadow-md transition cursor-pointer relative group";
							card.onclick = () => openModal(item);
							const statusBadge = item.score !== null ? `<span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full font-bold">已批改 ${item.score}分</span>` : `<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded-full font-bold">待批改</span>`;
							const displayName = item.student_name || `${item.lastname}${item.firstname}`;
							card.innerHTML = `
								<div class="aspect-video bg-gray-100 rounded-lg mb-3 overflow-hidden border">
									<img src="${item.student_image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x300?text=No+Image'">
								</div>
								<div class="flex justify-between items-start mb-1">
									<h3 class="font-bold text-gray-800 truncate flex-1">${displayName}</h3>
									${statusBadge}
								</div>
								<p class="text-xs text-gray-500 truncate">${item.homework_title}</p>
								<p class="text-[10px] text-gray-400 mt-2">${item.submit_time}</p>
							`;
							container.appendChild(card);
						});
					}
				} catch (e) {
					console.error(e);
				}
			}

			async function fetchAIModels() {
				try {
					const res = await fetch(`${API}?action=get_ai_models`);
					const json = await res.json();
					const select = document.getElementById("aiModelSelect");
					select.innerHTML = "";
					if (json.status === "success" && json.data.length > 0) {
						json.data.forEach((m) => {
							const opt = document.createElement("option");
							opt.value = m.model_alias;
							opt.innerText = m.model_name;
							select.appendChild(opt);
						});
					} else {
						select.innerHTML = '<option value="">未授权 AI 模型</option>';
					}
				} catch (e) {
					console.error(e);
				}
			}

			function openModal(data) {
				currentId = data.submission_id;
				currentHomeworkData = data;
				const displayName = data.student_name || `${data.lastname}${data.firstname}`;
				document.getElementById("modalTitle").innerText = `${displayName} 的作业`;
				document.getElementById("modalSubTitle").innerText = data.homework_title;
				document.getElementById("gradeScore").value = data.score !== null ? data.score : "";
				document.getElementById("gradeContent").value = data.comment || "";
				img.src = data.student_image;
				document.getElementById("gradeModal").classList.remove("hidden");
				document.body.classList.add("modal-active");
				img.onload = () => {
					canvas.width = img.clientWidth;
					canvas.height = img.clientHeight;
					clearCanvas();
				};
			}

			function closeModal() {
				document.getElementById("gradeModal").classList.add("hidden");
				document.body.classList.remove("modal-active");
			}

			function initCanvas() {
				const getPos = (e) => {
					const rect = canvas.getBoundingClientRect();
					const clientX = e.touches ? e.touches[0].clientX : e.clientX;
					const clientY = e.touches ? e.touches[0].clientY : e.clientY;
					return { x: clientX - rect.left, y: clientY - rect.top };
				};
				const start = (e) => {
					isDrawing = true;
					const p = getPos(e);
					ctx.beginPath();
					ctx.moveTo(p.x, p.y);
				};
				const draw = (e) => {
					if (!isDrawing) return;
					const p = getPos(e);
					ctx.lineWidth = 3;
					ctx.lineCap = "round";
					ctx.strokeStyle = "red";
					ctx.lineTo(p.x, p.y);
					ctx.stroke();
				};
				const end = () => {
					isDrawing = false;
				};
				canvas.addEventListener("mousedown", start);
				canvas.addEventListener("mousemove", draw);
				window.addEventListener("mouseup", end);
				canvas.addEventListener("touchstart", (e) => {
					e.preventDefault();
					start(e);
				});
				canvas.addEventListener("touchmove", (e) => {
					e.preventDefault();
					draw(e);
				});
				canvas.addEventListener("touchend", end);
			}

			function clearCanvas() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}

			async function runAIGrade() {
				const modelAlias = document.getElementById("aiModelSelect").value;
				const userInstruction = document.getElementById("aiInstruction").value;
				if (!modelAlias) return alert("请选择 AI 模型");
				const overlay = document.getElementById("aiLoading");
				overlay.classList.remove("hidden");

				// 优化：Prompt 仅保留文字要求，不再嵌入 Base64 数据
				const textPrompt = `你是一位专业的老师。
作业题目：${currentHomeworkData.homework_title}
老师的要求：${userInstruction || "请对作业进行评分并提供具体建议。"}

请分析图片中的内容，直接返回 JSON 格式，包含 score (0-100) 和 comment (点评)。`;

				try {
					const res = await fetch(`${API}?action=ai_grade`, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							submission_id: currentId,
							model_alias: modelAlias,
							prompt: textPrompt,
							student_image: currentHomeworkData.student_image, // 图片数据独立传输
						}),
					});
					const json = await res.json();
					if (json.status === "success") {
						let result = json.data;
						if (typeof result === "string") {
							try {
								result = JSON.parse(result.replace(/```json|```/g, ""));
							} catch (e) {}
						}
						document.getElementById("gradeScore").value = result.score || "";
						document.getElementById("gradeContent").value = result.comment || result.content || (typeof result === "string" ? result : "");
					} else {
						alert("AI 失败: " + json.message);
					}
				} catch (e) {
					alert("请求失败");
				}
				overlay.classList.add("hidden");
			}

			async function submitGrade() {
				const score = document.getElementById("gradeScore").value;
				const content = document.getElementById("gradeContent").value;
				const btn = document.getElementById("submitBtn");
				if (score === "") return alert("请输入评分");
				const drawingData = canvas.toDataURL("image/png");
				btn.disabled = true;
				btn.innerText = "保存中...";
				try {
					const res = await fetch(`${API}?action=submit_grade`, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ submission_id: currentId, score: score, content: content, check_image: drawingData }),
					});
					const json = await res.json();
					if (json.status === "success") {
						btn.innerText = "保存成功 ✅";
						setTimeout(() => {
							closeModal();
							fetchList();
							btn.disabled = false;
							btn.innerText = "确认并保存批改";
						}, 1000);
					} else {
						alert(json.message);
						btn.disabled = false;
						btn.innerText = "重新尝试";
					}
				} catch (e) {
					alert("网络错误");
					btn.disabled = false;
				}
			}
		</script>
	</body>
</html>
