<!doctype html>
<html lang="zh-TW">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>教师批改系统 (含绘图功能)</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			.no-scrollbar::-webkit-scrollbar {
				display: none;
			}
			.no-scrollbar {
				-ms-overflow-style: none;
				scrollbar-width: none;
			}
			.modal-active {
				overflow: hidden;
			}
			/* 画布容器，确保画布完全重叠在图片上方 */
			#canvas-container {
				position: relative;
				display: inline-block;
				line-height: 0;
			}
			#grading-canvas {
				position: absolute;
				top: 0;
				left: 0;
				touch-action: none; /* 防止触控时页面滚动，确保绘图流畅 */
				cursor: crosshair;
			}
		</style>
	</head>
	<body class="bg-gray-100 h-screen flex flex-col font-sans">
		<!-- 顶部标题与筛选器 -->
		<header class="bg-white shadow-md z-10 p-4 border-b">
			<div class="flex justify-between items-center mb-4">
				<h1 class="text-xl font-bold text-gray-800">作业批改工作台</h1>
				<button onclick="fetchList()" class="text-blue-600 font-medium text-sm">重新整理</button>
			</div>

			<!-- 筛选与搜寻区域 -->
			<div class="space-y-2">
				<div class="flex gap-2">
					<input type="text" id="searchName" placeholder="搜寻学生姓名..." class="flex-1 bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
					<input type="date" id="searchDate" class="w-40 bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
				</div>
				<div class="flex gap-2">
					<select id="filterStatus" class="flex-1 bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none">
						<option value="all">全部状态</option>
						<option value="ungraded">未批改</option>
						<option value="graded">已批改</option>
					</select>
					<select id="sortOrder" class="flex-1 bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none">
						<option value="desc">时间降序 (新→旧)</option>
						<option value="asc">时间升序 (旧→新)</option>
					</select>
				</div>
			</div>
		</header>

		<!-- 作业列表 -->
		<main id="homeworkList" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
			<div class="text-center text-gray-400 py-10 italic">载入中...</div>
		</main>

		<!-- 批改弹窗 (Modal) -->
		<div id="gradingModal" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden flex flex-col">
			<!-- 弹窗顶部 -->
			<div class="flex justify-between items-center p-4 bg-gray-900 text-white">
				<div class="flex-1 min-w-0 mr-4">
					<h3 id="modalStudentName" class="font-bold text-lg truncate">学生姓名</h3>
					<p id="modalHomeworkTitle" class="text-xs text-gray-400 truncate">作业标题</p>
				</div>
				<div class="flex items-center gap-3">
					<button onclick="clearCanvas()" class="bg-red-900/50 text-red-200 px-3 py-1 rounded text-xs border border-red-700">清除重画</button>
					<button onclick="closeModal()" class="text-3xl font-light">&times;</button>
				</div>
			</div>

			<!-- 作业图片与画布区域 -->
			<div class="flex-1 overflow-auto flex items-center justify-center p-2 bg-black">
				<div id="canvas-container">
					<img id="modalImage" src="" alt="作业图片" class="max-w-full max-h-full block" />
					<!-- 批改画布，尺寸会在图片加载后动态调整 -->
					<canvas id="grading-canvas"></canvas>
				</div>
				<div id="imageError" class="hidden text-gray-500 flex flex-col items-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
					</svg>
					<span>无法载入图片</span>
				</div>
			</div>

			<!-- 评分控制台 -->
			<div class="bg-white p-5 rounded-t-2xl shadow-2xl">
				<div class="flex gap-4 mb-4">
					<div class="w-1/3 text-center border-r border-gray-100">
						<label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">评分</label>
						<input type="number" id="gradeScore" min="0" max="100" class="w-full text-center text-3xl font-bold text-red-600 border-b-2 border-transparent focus:border-red-500 outline-none py-1" placeholder="0" />
					</div>
					<div class="w-2/3">
						<label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">批语</label>
						<textarea id="gradeContent" rows="1" class="w-full border-b-2 border-gray-100 focus:border-blue-500 outline-none py-2 text-sm resize-none" placeholder="请输入评语 (选填)"></textarea>
					</div>
				</div>
				<button id="submitBtn" onclick="submitGrade()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform shadow-lg shadow-blue-200">确认并保存批改</button>
			</div>
		</div>

		<script>
			const API = "/system/teacher-grading.php";
			const VIEW_IMG = "/system/teacher-grading-image-view.php";
			let currentId = null;

			// 画布相关变量
			const canvas = document.getElementById("grading-canvas");
			const ctx = canvas.getContext("2d");
			let isDrawing = false;

			document.addEventListener("DOMContentLoaded", () => {
				fetchList();
				setupCanvas();

				// 绑定筛选事件
				document.getElementById("searchName").addEventListener("input", debounce(fetchList, 500));
				document.getElementById("searchDate").addEventListener("change", fetchList);
				document.getElementById("filterStatus").addEventListener("change", fetchList);
				document.getElementById("sortOrder").addEventListener("change", fetchList);
			});

			// 初始化画布监听
			function setupCanvas() {
				const getPos = (e) => {
					const rect = canvas.getBoundingClientRect();
					// 处理触控与滑鼠的不同坐标获取
					const clientX = e.touches ? e.touches[0].clientX : e.clientX;
					const clientY = e.touches ? e.touches[0].clientY : e.clientY;

					// 将屏幕坐标转换为 Canvas 内部的绘图坐标
					return {
						x: (clientX - rect.left) * (canvas.width / rect.width),
						y: (clientY - rect.top) * (canvas.height / rect.height),
					};
				};

				const start = (e) => {
					isDrawing = true;
					const pos = getPos(e);
					ctx.beginPath();
					ctx.moveTo(pos.x, pos.y);
					// 防止移动端拖动页面
					if (e.touches) e.preventDefault();
				};

				const move = (e) => {
					if (!isDrawing) return;
					const pos = getPos(e);
					ctx.lineTo(pos.x, pos.y);
					ctx.strokeStyle = "red"; // 批改统一使用红色
					ctx.lineWidth = 5; // 线条宽度
					ctx.lineCap = "round"; // 圆润线条
					ctx.lineJoin = "round";
					ctx.stroke();
					if (e.touches) e.preventDefault();
				};

				const stop = () => {
					isDrawing = false;
				};

				// 滑鼠事件
				canvas.addEventListener("mousedown", start);
				canvas.addEventListener("mousemove", move);
				window.addEventListener("mouseup", stop);

				// 触控事件
				canvas.addEventListener("touchstart", start, { passive: false });
				canvas.addEventListener("touchmove", move, { passive: false });
				canvas.addEventListener("touchend", stop);
			}

			// 清除画布
			function clearCanvas() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}

			// 获取作业列表
			async function fetchList() {
				const listContainer = document.getElementById("homeworkList");
				const params = new URLSearchParams({
					action: "list",
					student_name: document.getElementById("searchName").value,
					date: document.getElementById("searchDate").value,
					status: document.getElementById("filterStatus").value,
					sort: document.getElementById("sortOrder").value,
				});

				try {
					const res = await fetch(`${API}?${params}`);
					if (res.status === 401) return (window.location.href = "/teacher/login.html");
					const json = await res.json();
					if (json.status !== "success") throw new Error(json.message);

					listContainer.innerHTML =
						json.data.length === 0
							? `<div class="text-center py-20 text-gray-400 italic">目前没有符合条件的作业</div>`
							: json.data
									.map(
										(item) => `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center active:bg-blue-50 transition"
                             onclick="openGrade(${item.id}, '${item.student_name}', '${item.homework_title}', '${item.score || ""}')">
                            <div class="flex-1 min-w-0 pr-4">
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-bold text-gray-800 text-lg">${item.student_name}</h4>
                                    ${item.is_graded ? `<span class="px-2 py-0.5 bg-green-100 text-green-600 text-[10px] rounded font-bold">${item.score} 分</span>` : `<span class="px-2 py-0.5 bg-orange-100 text-orange-600 text-[10px] rounded font-bold">待批改</span>`}
                                </div>
                                <p class="text-sm text-gray-600 truncate">${item.homework_title}</p>
                                <p class="text-[10px] text-gray-400 mt-1">提交：${item.submit_time}</p>
                            </div>
                            <div class="text-gray-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            </div>
                        </div>
                    `,
									)
									.join("");
				} catch (err) {
					listContainer.innerHTML = `<div class="text-center text-red-400 py-10">资料载入错误: ${err.message}</div>`;
				}
			}

			// 打开批改弹窗
			function openGrade(id, name, title, score) {
				currentId = id;
				document.getElementById("modalStudentName").innerText = name;
				document.getElementById("modalHomeworkTitle").innerText = title;
				document.getElementById("gradeScore").value = score;
				document.getElementById("gradeContent").value = "";

				const img = document.getElementById("modalImage");
				const err = document.getElementById("imageError");

				// 载入学生作业原图
				img.src = `${VIEW_IMG}?type=submission&id=${id}&t=${Date.now()}`;
				img.classList.add("hidden");
				err.classList.add("hidden");
				clearCanvas();

				img.onload = () => {
					img.classList.remove("hidden");

					// 1. 同步画布的物理像素尺寸（原始解析度）
					canvas.width = img.naturalWidth;
					canvas.height = img.naturalHeight;

					// 2. 同步画布的显示尺寸（CSS 宽高）
					canvas.style.width = img.clientWidth + "px";
					canvas.style.height = img.clientHeight + "px";

					// 3. 尝试载入已有的批改图层（透明 PNG）
					const checkImg = new Image();
					// 这里 type=check 对应 view_image.php 中从 homeworkcheck 表读取的逻辑
					checkImg.src = `${VIEW_IMG}?type=check&id=${id}&t=${Date.now()}`;
					checkImg.crossOrigin = "anonymous";
					checkImg.onload = () => {
						// 将旧的批改绘制到画布上，实现“在原本基础上画图”
						ctx.drawImage(checkImg, 0, 0);
					};
				};
				img.onerror = () => {
					err.classList.remove("hidden");
					img.classList.add("hidden");
				};

				document.getElementById("gradingModal").classList.remove("hidden");
				document.body.classList.add("modal-active");
			}

			// 关闭弹窗
			function closeModal() {
				document.getElementById("gradingModal").classList.add("hidden");
				document.body.classList.remove("modal-active");
				currentId = null;
			}

			// 提交批改结果
			async function submitGrade() {
				const score = document.getElementById("gradeScore").value;
				const content = document.getElementById("gradeContent").value;
				const btn = document.getElementById("submitBtn");

				if (score === "") return alert("请输入评分分数");

				// 将画布内容转换为透明的 Base64 PNG 图片
				const drawingData = canvas.toDataURL("image/png");

				btn.disabled = true;
				btn.innerText = "储存中...";

				try {
					const res = await fetch(`${API}?action=submit_grade`, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							submission_id: currentId,
							score: score,
							content: content,
							check_image: drawingData, // 传送绘图 Base64 到后端
						}),
					});
					const json = await res.json();

					if (json.status === "success") {
						btn.innerText = "储存成功 ✅";
						btn.classList.replace("bg-blue-600", "bg-green-600");
						setTimeout(() => {
							closeModal();
							fetchList(); // 重新整理列表
							btn.disabled = false;
							btn.innerText = "确认并保存批改";
							btn.classList.replace("bg-green-600", "bg-blue-600");
						}, 1000);
					} else {
						alert(json.message);
						btn.disabled = false;
						btn.innerText = "确认并保存批改";
					}
				} catch (err) {
					alert("网路传输失败，请检查连线");
					btn.disabled = false;
					btn.innerText = "确认并保存批改";
				}
			}

			// 工具：防抖函数
			function debounce(func, wait) {
				let timeout;
				return (...args) => {
					clearTimeout(timeout);
					timeout = setTimeout(() => func.apply(this, args), wait);
				};
			}
		</script>
	</body>
</html>
