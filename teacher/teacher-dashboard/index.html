<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1, minimum-scale=1" />
		<title>班级管理面板</title>

		<!-- 载入 Bootstrap 5 CSS -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
		<!-- 载入 Bootstrap Icons -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

		<style>
			/* --- 触控与缩放限制 (与副本一致) --- */
			html {
				touch-action: none;
				-ms-text-size-adjust: 100%;
				-moz-text-size-adjust: 100%;
				-webkit-text-size-adjust: 100%;
				zoom: 1;
			}

			/* --- 页面基础样式 --- */
			body {
				background-color: #f8f9fa; /* 浅灰色背景 */
				font-family: "Inter", sans-serif;
			}

			/* --- Tab 切换淡入淡出动画 --- */
			.tab-pane-fade {
				display: none;
				opacity: 0;
				transition: opacity 0.1s ease-in-out;
			}
			.tab-pane-fade.active-block {
				display: block;
			}
			.tab-pane-fade.show {
				opacity: 1;
			}

			/* 修正 Accordion 圆角，使其内部的 list-group-item 不带圆角 */
			.accordion-body .list-group-item:first-child {
				border-top-left-radius: 0;
				border-top-right-radius: 0;
			}
			.accordion-body .list-group-item:last-child {
				border-bottom-left-radius: 0;
				border-bottom-right-radius: 0;
			}

			/* iframe 样式，确保内容区自适应高度 */
			iframe {
				width: 100%;
				border: none;
				height: calc(100vh - 200px);
				min-height: 500px;
			}
		</style>
	</head>

	<body class="min-vh-100 d-flex flex-column">
		<!-- 会话过期提示模态框 (Bootstrap Modal) -->
		<div class="modal fade" id="session-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="sessionModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header border-bottom-0 pb-0">
						<h5 class="modal-title text-danger fw-bold" id="sessionModalLabel">会话过期通知</h5>
					</div>
					<div class="modal-body text-secondary">
						<p>登录已过期，请重新登录！</p>
					</div>
					<div class="modal-footer border-top-0 pt-0">
						<button id="modal-confirm-btn" type="button" class="btn btn-primary w-100">了解</button>
					</div>
				</div>
			</div>
		</div>

		<!-- 主面板容器 -->
		<div class="container py-4">
			<!-- 标题区块 -->
			<header class="mb-4 border-bottom pb-3">
				<h1 class="display-6 fw-bold text-dark">班级平台 教师管理面板</h1>
				<p class="text-muted mt-1">在此管理班级平台的所有核心数据和功能。</p>
			</header>

			<!-- 栅格布局 -->
			<div class="row g-4">
				<!-- 侧边栏导航 (Accordion Sidebar) -->
				<div class="col-md-3">
					<div class="sticky-top" style="top: 20px; z-index: 100">
						<!-- 独立模块：返回主页 -->
						<div class="card shadow-sm border-0 mb-3 rounded-3">
							<div class="list-group list-group-flush rounded-3">
								<button class="list-group-item list-group-item-action py-3 border-0 text-primary fw-bold d-flex align-items-center" onclick="location.href = '/teacher/index.html'">
									<i class="bi bi-arrow-left-circle-fill me-2 fs-5"></i>
									<span>返回主页</span>
								</button>
							</div>
						</div>

						<!-- 主要功能菜单 (Accordion) -->
						<div class="accordion shadow-sm" id="sidebarAccordion">
							<!-- 分组：教学管理 -->
							<div class="accordion-item">
								<h2 class="accordion-header" id="headingTeach">
									<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTeach" aria-expanded="true" aria-controls="collapseTeach">教学管理</button>
								</h2>
								<div id="collapseTeach" class="accordion-collapse collapse show" aria-labelledby="headingTeach" data-bs-parent="#sidebarAccordion">
									<div class="accordion-body p-0">
										<div class="list-group list-group-flush">
											<button class="list-group-item list-group-item-action py-3 border-0 active" onclick="showTab('students')" data-tab="students">学生管理</button>
											<button class="list-group-item list-group-item-action py-3 border-0" onclick="showTab('homework')" data-tab="homework">家庭作业</button>
											<button class="list-group-item list-group-item-action py-3 border-0" onclick="showTab('homework-grading')" data-tab="homework-grading">作业批改</button>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- 主内容区 -->
				<div class="col-md-9">
					<div class="card shadow-sm border-0 rounded-3">
						<div class="card-body p-0">
							<!-- 学生管理 -->
							<div id="students" class="tab-pane-fade active-block show">
								<iframe src="/teacher/teacher-dashboard/students.html" id="students-iframe"></iframe>
							</div>

							<!-- 家庭作业 -->
							<div id="homework" class="tab-pane-fade">
								<iframe src="/teacher/teacher-dashboard/homework.html" id="homework-iframe"></iframe>
							</div>

							<!-- 家庭作业批改 -->
							<div id="homework-grading" class="tab-pane-fade">
								<iframe src="/teacher/teacher-dashboard/grading.html" id="homework-grading-iframe"></iframe>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- 载入 Bootstrap 5 JS Bundle -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<!-- 载入 Cookies 库 -->
		<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

		<script>
			// --- 全局常量 ---
			const SESSION_CHECK_URL = "/system/teacher-profile.php";
			const LOGIN_URL = "/teacher/login.html";
			const CHECK_INTERVAL = 10000;

			let sessionInterval;

			// --- 模态框处理函数 ---
			function showSessionExpiredModal() {
				const modalElement = document.getElementById("session-modal");
				const modal = new bootstrap.Modal(modalElement);
				modal.show();
			}

			function handleModalConfirm() {
				clearInterval(sessionInterval);
				window.location.href = LOGIN_URL;
			}

			// --- 会话检查逻辑 ---
			async function attemptSessionCheck() {
				try {
					const response = await fetch(SESSION_CHECK_URL, { method: "GET", cache: "no-store" });
					if (response.status === 200 || response.status === 500) {
						return true;
					} else {
						return false;
					}
				} catch (error) {
					return false;
				}
			}

			async function checkSession() {
				const firstAttemptSuccess = await attemptSessionCheck();
				if (firstAttemptSuccess) return;

				await new Promise((resolve) => setTimeout(resolve, 1000));

				const secondAttemptSuccess = await attemptSessionCheck();
				if (secondAttemptSuccess) return;

				clearInterval(sessionInterval);
				showSessionExpiredModal();
			}

			// --- 页面功能逻辑：Tab 切换（含淡入淡出） ---
			function showTab(tabId) {
				// 1) 隐藏所有面板
				document.querySelectorAll(".tab-pane-fade").forEach((pane) => {
					pane.classList.remove("show");
					pane.classList.remove("active-block");
				});

				// 2) 取消所有菜单 active
				document.querySelectorAll("[data-tab]").forEach((btn) => {
					btn.classList.remove("active");
				});

				// 3) 激活目标面板
				const targetPane = document.getElementById(tabId);
				if (targetPane) {
					targetPane.classList.add("active-block");
					// 让浏览器先渲染 display:block，再触发 opacity 动画
					requestAnimationFrame(() => targetPane.classList.add("show"));
				}

				// 4) 激活目标按钮
				const targetBtn = document.querySelector(`[data-tab="${tabId}"]`);
				if (targetBtn) targetBtn.classList.add("active");
			}

			document.addEventListener("DOMContentLoaded", () => {
				// 1. 初始 Cookie 检查
				if (Cookies.get("token") === undefined) {
					window.location.href = LOGIN_URL;
					return;
				}

				// 2. 默认显示：学生管理
				showTab("students");

				// 3. 启动会话心跳检查
				checkSession();
				sessionInterval = setInterval(checkSession, CHECK_INTERVAL);

				// 4. 模态框按钮
				document.getElementById("modal-confirm-btn").addEventListener("click", handleModalConfirm);
			});
		</script>
	</body>
</html>
