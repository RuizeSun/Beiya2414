<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<!-- 引入 Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			body {
				background-color: #f7f9fb;
			}
			.loading-spinner {
				border-top-color: #3b82f6;
			}
		</style>
	</head>
	<body>
		<div id="auth-error-container" class="hidden">
			<!-- 这里会显示来自 score_api.php 的 HTML 授权错误讯息 -->
		</div>

		<!-- 讯息/错误提示区 -->
		<div id="message-box" class="hidden p-3 mb-4 rounded-lg text-sm transition duration-300"></div>

		<!-- 筛选器区域 -->
		<div class="bg-gray-50 p-4 rounded-lg mb-6 shadow-inner">
			<h3 class="text-lg font-semibold text-gray-700 mb-3">筛选与查询</h3>
			<div class="grid grid-cols-1 md:grid-cols-5 gap-4">
				<!-- 学生 ID 筛选 -->
				<input type="text" id="filter-student-id" placeholder="学生 ID (留空查全部)" class="col-span-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />

				<!-- 变动原因筛选 -->
				<select id="filter-reason" class="col-span-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
					<option value="">所有加/减分项</option>
					<!-- 选项将由 JS 填充 -->
				</select>

				<!-- 起始日期筛选 -->
				<input type="date" id="filter-start-date" placeholder="起始日期" class="col-span-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />

				<!-- 结束日期筛选 -->
				<input type="date" id="filter-end-date" placeholder="结束日期" class="col-span-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />

				<!-- 查询按钮 -->
				<button onclick="fetchLogs(true)" class="col-span-1 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition duration-150 transform hover:scale-105">查询/筛选</button>
			</div>

			<!-- 记录列表表格 -->
			<div class="overflow-x-auto shadow-inner rounded-lg border border-gray-100">
				<table class="min-w-full divide-y divide-gray-200">
					<thead class="bg-blue-50">
						<tr>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学生 (ID)</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">变动量</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">变动原因/项目</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作教师</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作时间</th>
							<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
						</tr>
					</thead>
					<tbody id="logs-table-body" class="bg-white divide-y divide-gray-100">
						<tr>
							<td colspan="7" class="p-4 text-center text-gray-500">请输入筛选条件或点击查询加载数据...</td>
						</tr>
					</tbody>
				</table>
			</div>

			<!-- 加载更多按钮 -->
			<div id="load-more-container" class="mt-6 text-center hidden">
				<button id="load-more-btn" onclick="fetchLogs(false)" class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-150">加载更多数据 (20 项)</button>
			</div>

			<!-- 载入指示器 -->
			<div id="loading-indicator" class="mt-6 text-center hidden">
				<div class="loading-spinner inline-block w-6 h-6 border-4 border-gray-200 border-solid rounded-full animate-spin"></div>
				<span class="text-gray-500 ml-2">数据载入中...</span>
			</div>
		</div>

		<script>
			const API_URL = "/system/admin-dashboard-scorechangelog.php";
			const tableBody = document.getElementById("logs-table-body");
			const messageBox = document.getElementById("message-box");
			const loadMoreContainer = document.getElementById("load-more-container");
			const loadingIndicator = document.getElementById("loading-indicator");
			const reasonSelect = document.getElementById("filter-reason");

			let currentOffset = 0;
			let isFetching = false;

			/**
			 * 显示提示讯息
			 * @param {string} message 讯息内容
			 * @param {string} type 'success' or 'error'
			 */
			function showMessage(message, type = "success") {
				messageBox.textContent = message;
				messageBox.classList.remove("hidden", "bg-red-100", "text-red-700", "bg-green-100", "text-green-700");

				if (type === "error") {
					messageBox.classList.add("bg-red-100", "text-red-700", "border", "border-red-400");
				} else {
					messageBox.classList.add("bg-green-100", "text-green-700", "border", "border-green-400");
				}

				setTimeout(() => {
					messageBox.classList.add("hidden");
				}, 5000);
			}

			/**
			 * 执行 API 请求 (手动构建 GET 参数以确保可靠性)
			 * 此处已修复：即使 studentId 为空，也会被正确传递。
			 */
			async function apiRequest(action, method = "GET", data = null) {
				const options = {
					method: method,
					headers: {},
				};

				let url = `${API_URL}?action=${action}`;

				if (data && method === "GET") {
					const paramsArray = [];
					// 手动构建查询字串，确保所有参数 (包括 studentId) 都被正确传输
					for (const key in data) {
						if (data.hasOwnProperty(key)) {
							// 即使值是空字串，我们也需要传递，例如 studentId=''
							paramsArray.push(`${encodeURIComponent(key)}=${encodeURIComponent(data[key])}`);
						}
					}
					if (paramsArray.length > 0) {
						url += "&" + paramsArray.join("&");
					}
				} else if (data && method === "POST") {
					options.headers["Content-Type"] = "application/json";
					options.body = JSON.stringify(data);
				}

				try {
					const response = await fetch(url, options);

					// 检查 Content-Type: 如果是 HTML，表示发生了 401 授权错误
					const contentType = response.headers.get("content-type");
					if (contentType && contentType.indexOf("text/html") !== -1) {
						const htmlError = await response.text();
						document.getElementById("score-panel").classList.add("hidden");
						const authErrorContainer = document.getElementById("auth-error-container");
						authErrorContainer.innerHTML = htmlError;
						authErrorContainer.classList.remove("hidden");
						return { status: "error", message: "未授权访问" };
					}

					const result = await response.json();

					if (result.status === "error") {
						throw new Error(result.message);
					}

					return result;
				} catch (error) {
					console.error("API 请求错误:", error.message);
					showMessage(error.message, "error");
					return { status: "error", message: error.message };
				}
			}

			/**
			 * 将日期字串转换为 Unix 时间戳
			 */
			function dateToTimestamp(dateString, isEnd = false) {
				if (!dateString) return 0;
				// 处理时区，确保时间点在当天的开始或结束
				const date = new Date(dateString);
				if (isEnd) {
					// 结束日期设置为当天 23:59:59
					date.setHours(23, 59, 59, 999);
				} else {
					// 开始日期设置为当天 00:00:00
					date.setHours(0, 0, 0, 0);
				}
				// 转换为秒级时间戳
				return Math.floor(date.getTime() / 1000);
			}

			/**
			 * 载入并显示变动记录
			 * @param {boolean} reset 是否重置分页（新查询/筛选）
			 */
			async function fetchLogs(reset = true) {
				if (isFetching) return;
				isFetching = true;
				loadingIndicator.classList.remove("hidden");
				loadMoreContainer.classList.add("hidden");

				if (reset) {
					currentOffset = 0;
					tableBody.innerHTML = "";
				}

				const studentId = document.getElementById("filter-student-id").value.trim();
				const reason = reasonSelect.value;

				const startDateStr = document.getElementById("filter-start-date").value;
				const endDateStr = document.getElementById("filter-end-date").value;

				const startDate = dateToTimestamp(startDateStr, false);
				const endDate = dateToTimestamp(endDateStr, true);

				if (reset) {
					tableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500 animate-pulse">正在加载数据...</td></tr>';
				}

				// 传递所有筛选参数，让后端根据空字串判断是否进行筛选
				const params = {
					offset: currentOffset,
					studentId: studentId, // 确保即使为空字串 (查全部)，也会传递
					reason: reason,
					startDate: startDate,
					endDate: endDate,
				};

				const result = await apiRequest("list", "GET", params);

				loadingIndicator.classList.add("hidden");
				isFetching = false;

				if (result.status === "success") {
					if (reset) {
						tableBody.innerHTML = "";
					}

					const logs = result.data;
					const totalLogs = tableBody.rows.length + logs.length;

					if (totalLogs === 0) {
						tableBody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">${reset ? "未找到符合筛选条件的记录" : "已加载全部记录"}</td></tr>`;
						loadMoreContainer.classList.add("hidden");
						return;
					}

					renderLogs(logs);

					if (result.hasMore) {
						currentOffset = result.nextOffset;
						loadMoreContainer.classList.remove("hidden");
					} else {
						loadMoreContainer.classList.add("hidden");
					}
				} else if (result.status === "error" && result.message !== "未授权访问") {
					tableBody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-red-600">载入失败: ${result.message}</td></tr>`;
				}
			}

			/**
			 * 渲染表格内容
			 * @param {Array} logs 记录资料阵列
			 */
			function renderLogs(logs) {
				const rowsHtml = logs
					.map((log) => {
						const isUndo = log.isUndo;
						const changeColor = log.change > 0 ? "text-green-600" : log.change < 0 ? "text-red-600" : "text-gray-500";
						const rowClass = isUndo ? "bg-yellow-50 hover:bg-yellow-100 transition duration-100" : "hover:bg-gray-50 transition duration-100";

						// 撤销按钮逻辑
						let actionButton = "";
						if (!isUndo) {
							actionButton = `<button onclick="handleUndo(${log.Id}, ${log.change}, '${log.studentName}')" 
                                class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition duration-150 text-sm font-medium">
                            撤销
                        </button>`;
						} else {
							actionButton = `<span class="text-gray-400 text-sm">已撤销</span>`;
						}

						return `
                    <tr class="${rowClass}">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${log.Id}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${log.studentName} (${log.studentid})</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-bold ${changeColor}">${log.change > 0 ? "+" : ""}${log.change.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-normal text-sm text-gray-800">${log.reason}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${log.teacherName}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${log.datetime}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium">${actionButton}</td>
                    </tr>
                `;
					})
					.join("");

				tableBody.insertAdjacentHTML("beforeend", rowsHtml);
			}

			/**
			 * 处理撤销变动
			 * @param {number} Id 原始记录 ID
			 * @param {number} change 原始变动量
			 * @param {string} studentName 学生姓名
			 */
			async function handleUndo(Id, change, studentName) {
				const undoValue = -change;

				// 使用自定义的确认框 (避免浏览器原生的 alert/confirm)
				if (!window.confirm(`确定要撤销对学生 ${studentName} 的变动 (ID: ${Id}，变动量: ${change}) 吗？\n\n系统将新增一条变动量为 ${undoValue.toFixed(2)} 的记录来抵消。`)) {
					return;
				}

				const result = await apiRequest("undo", "POST", { originalLogId: Id });

				if (result.status === "success") {
					showMessage(result.message, "success");
					fetchLogs(true); // 撤销后重新加载列表
				} else {
					showMessage(result.message, "error");
				}
			}

			/**
			 * 加载所有加分/减分项类型到筛选下拉选单
			 */
			async function loadReasonTypes() {
				const result = await apiRequest("types", "GET");

				if (result.status === "success") {
					// 清空现有选项，保留默认选项
					reasonSelect.innerHTML = '<option value="">所有加/减分项</option>';

					// result.data 结构: [{value: 'reason_id/string', text: 'display_name'}]
					result.data.forEach((item) => {
						const option = document.createElement("option");
						option.value = item.value; // 用于查询的 reason ID 或字串
						option.textContent = item.text; // 用于显示的名称
						reasonSelect.appendChild(option);
					});
				} else {
					console.error("无法加载变动原因类型:", result.message);
					showMessage("无法加载变动原因类型供筛选", "error");
				}
			}

			// 初始化：加载所有类型
			document.addEventListener("DOMContentLoaded", loadReasonTypes);
		</script>
	</body>
</html>
