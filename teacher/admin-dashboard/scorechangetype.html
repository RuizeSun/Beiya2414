<!DOCTYPE html>
<html lang="zh-Hans">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

		<title>量化评分改动项管理 (管理员)</title>
		<!-- 引入 Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			/* 模态框背景和按钮动画 */
			.modal-overlay {
				background-color: rgba(0, 0, 0, 0.75);
				transition: opacity 0.3s ease;
			}
			.btn-primary {
				transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
			}
			.btn-primary:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			}
		</style>
	</head>
	<body>
		<div>
			<!-- 消息提示框 -->
			<div id="message-box" class="hidden mb-4 p-3 rounded-xl text-white font-medium shadow-md" role="alert"></div>

			<!-- 顶部操作区 -->
			<div class="flex flex-col sm:flex-row justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-lg">
				<h2 class="text-xl font-semibold text-gray-700 mb-4 sm:mb-0">项目列表</h2>
				<button onclick="openModal()" class="btn-primary bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl shadow-lg w-full sm:w-auto flex items-center justify-center">
					<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
					新增改动项
				</button>
			</div>

			<!-- 数据表格 -->
			<div class="bg-white rounded-xl shadow-lg overflow-x-auto">
				<table class="min-w-full divide-y divide-gray-200">
					<thead class="bg-indigo-50">
						<tr>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称 (加分/减分项)</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">改动量</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最后修改时间</th>
							<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
						</tr>
					</thead>
					<tbody id="scorechangetype-list" class="bg-white divide-y divide-gray-100">
						<!-- 数据将由 JavaScript 填充 -->
					</tbody>
				</table>

				<!-- 列表为空时的占位符 -->
				<div id="empty-state" class="p-6 text-center text-gray-500 hidden">
					<p>目前没有评分改动项记录。</p>
				</div>

				<!-- 加载指示器 -->
				<div id="loading-indicator" class="p-6 text-center text-indigo-600 hidden">
					<svg class="animate-spin h-6 w-6 mx-auto text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
						<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
						<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
					</svg>
					<p class="mt-2">正在加载数据...</p>
				</div>
			</div>
		</div>

		<!-- 模态框 (新增/编辑) -->
		<div id="edit-modal" class="fixed inset-0 z-50 hidden modal-overlay flex items-center justify-center p-4" onclick="if(event.target.id === 'edit-modal') closeModal()">
			<div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all duration-300" onclick="event.stopPropagation()">
				<h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">新增改动项</h3>
				<form id="edit-form" onsubmit="handleFormSubmit(event)">
					<input type="hidden" id="item-id" />

					<div class="mb-4">
						<label for="item-name" class="block text-sm font-medium text-gray-700 mb-1">名称 (加分/减分项)</label>
						<input type="text" id="item-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：优秀奖, 旷课" />
					</div>

					<div class="mb-6">
						<label for="item-change" class="block text-sm font-medium text-gray-700 mb-1">改动量 (Change)</label>
						<input type="number" step="0.01" id="item-change" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="正值加分 (例如: 1.5), 负值减分 (例如: -0.5)" />
					</div>

					<div class="flex justify-end space-x-3">
						<button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-800 font-medium rounded-xl hover:bg-gray-400 transition duration-150">取消</button>
						<button type="submit" class="btn-primary bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-xl shadow-lg">保存</button>
					</div>
				</form>
			</div>
		</div>

		<script>
			const API_URL = "/system/admin-dashboard-scorechangetype.php";
			const listContainer = document.getElementById("scorechangetype-list");
			const modal = document.getElementById("edit-modal");
			const form = document.getElementById("edit-form");
			const modalTitle = document.getElementById("modal-title");
			const itemId = document.getElementById("item-id");
			const itemName = document.getElementById("item-name");
			const itemChange = document.getElementById("item-change");
			const loadingIndicator = document.getElementById("loading-indicator");
			const emptyState = document.getElementById("empty-state");
			const messageBox = document.getElementById("message-box");

			// --- 辅助函数 ---

			/**
			 * 显示操作消息 (成功/失败)
			 * @param {string} message
			 * @param {string} type 'success' or 'error'
			 */
			function showMessage(message, type = "success") {
				messageBox.textContent = message;
				messageBox.classList.remove("hidden", "bg-green-600", "bg-red-600");
				if (type === "success") {
					messageBox.classList.add("bg-green-600");
				} else {
					messageBox.classList.add("bg-red-600");
				}
				// 自动隐藏消息
				setTimeout(() => {
					messageBox.classList.add("hidden");
				}, 5000);
			}

			/**
			 * 将 Unix 时间戳转换为可读的日期时间格式 (YYYY-MM-DD HH:MM:SS)
			 * @param {number} timestamp Unix 时间戳
			 * @returns {string} 格式化后的时间字符串
			 */
			function formatTimestamp(timestamp) {
				if (!timestamp) return "N/A";
				const date = new Date(timestamp * 1000);
				return date
					.toLocaleString("zh-Hans", {
						year: "numeric",
						month: "2-digit",
						day: "2-digit",
						hour: "2-digit",
						minute: "2-digit",
						second: "2-digit",
					})
					.replace(/\//g, "-")
					.replace(" ", " ");
			}

			/**
			 * 渲染表格行
			 * @param {Object} item 评分改动项对象
			 */
			function renderItem(item) {
				const row = document.createElement("tr");
				row.id = `item-${item.Id}`;
				row.classList.add("hover:bg-gray-50", "transition-colors");

				const changeClass = item.change > 0 ? "text-green-600 font-semibold" : item.change < 0 ? "text-red-600 font-semibold" : "text-gray-500";

				row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.Id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${changeClass}">${item.change.toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatTimestamp(item.timestamp)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="openModal(${item.Id}, '${item.name.replace(/'/g, "\\'")}', ${item.change})" class="text-indigo-600 hover:text-indigo-900 mr-3 p-1 rounded-md hover:bg-indigo-50 transition duration-150">编辑</button>
                    <button onclick="deleteItem(${item.Id}, '${item.name.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-900 p-1 rounded-md hover:bg-red-50 transition duration-150">删除</button>
                </td>
            `;
				listContainer.appendChild(row);
			}

			// --- CRUD 操作 ---

			/**
			 * 获取所有评分改动项
			 */
			async function fetchItems() {
				listContainer.innerHTML = "";
				loadingIndicator.classList.remove("hidden");
				emptyState.classList.add("hidden");

				try {
					const response = await fetch(API_URL, { method: "GET" });

					if (response.status === 401) {
						// 如果是未经授权，服务器会返回 HTML 错误页面，我们尝试显示一个 JSON 错误提示
						showMessage("管理员身份验证失败，请确保您的管理员 Token Cookie 有效。", "error");
						// 为了防止在加载指示器上叠加错误，强制隐藏加载
						loadingIndicator.classList.add("hidden");
						return;
					}

					const result = await response.json();

					if (result.status === "success") {
						if (result.data.length === 0) {
							emptyState.classList.remove("hidden");
						} else {
							result.data.forEach((item) => renderItem(item));
						}
					} else {
						showMessage(result.message || "获取数据失败。", "error");
					}
				} catch (error) {
					console.error("Fetch error:", error);
					showMessage("网络请求失败或服务器无响应。", "error");
				} finally {
					loadingIndicator.classList.add("hidden");
				}
			}

			/**
			 * 处理表单提交 (新增/编辑)
			 */
			async function handleFormSubmit(event) {
				event.preventDefault();

				const id = itemId.value;
				const name = itemName.value.trim();
				const change = parseFloat(itemChange.value);

				if (isNaN(change)) {
					showMessage("改动量必须是有效的数字。", "error");
					return;
				}

				const isEditing = !!id;
				const method = isEditing ? "PUT" : "POST";

				// 锁定表单按钮
				const submitBtn = form.querySelector('button[type="submit"]');
				submitBtn.disabled = true;
				submitBtn.textContent = isEditing ? "正在更新..." : "正在保存...";

				let body;
				let headers = {};

				if (isEditing) {
					// PUT 请求使用 x-www-form-urlencoded 格式
					body = new URLSearchParams({
						Id: id,
						name: name,
						change: change,
					}).toString();
					headers["Content-Type"] = "application/x-www-form-urlencoded";
				} else {
					// POST 请求使用 JSON 格式
					body = JSON.stringify({ name, change });
					headers["Content-Type"] = "application/json";
				}

				try {
					const response = await fetch(API_URL, {
						method: method,
						headers: headers,
						body: body,
					});

					const result = await response.json();

					if (result.status === "success") {
						showMessage(result.message, "success");
						closeModal();
						// 刷新数据以确保列表是最新的
						await fetchItems();
					} else {
						showMessage(result.message || (isEditing ? "更新失败" : "创建失败"), "error");
					}
				} catch (error) {
					console.error("Submit error:", error);
					showMessage("提交请求失败。", "error");
				} finally {
					submitBtn.disabled = false;
					submitBtn.textContent = "保存";
				}
			}

			/**
			 * 删除评分改动项
			 * @param {number} id
			 * @param {string} name
			 */
			async function deleteItem(id, name) {
				// 使用自定义的确认框替代原生 confirm
				if (!window.confirm(`确定要删除改动项 "${name}" (ID: ${id}) 吗？\n\n请注意：此操作不可撤销！`)) {
					return;
				}

				try {
					const response = await fetch(API_URL, {
						method: "DELETE",
						headers: {
							"Content-Type": "application/x-www-form-urlencoded",
						},
						body: new URLSearchParams({ Id: id }).toString(),
					});

					const result = await response.json();

					if (result.status === "success") {
						showMessage(result.message, "success");
						// 从 DOM 中移除该行
						const row = document.getElementById(`item-${id}`);
						if (row) row.remove();
						// 检查是否列表为空
						if (listContainer.children.length === 0) {
							emptyState.classList.remove("hidden");
						}
					} else {
						showMessage(result.message || "删除失败", "error");
					}
				} catch (error) {
					console.error("Delete error:", error);
					showMessage("删除请求失败。", "error");
				}
			}

			// --- 模态框控制 ---

			/**
			 * 打开模态框进行新增或编辑
			 * @param {number|null} id
			 * @param {string} name
			 * @param {number} change
			 */
			function openModal(id = null, name = "", change = "") {
				if (id) {
					modalTitle.textContent = "编辑改动项 (ID: " + id + ")";
					itemId.value = id;
					itemName.value = name;
					// 使用 toFixed(2) 确保输入框显示浮点数
					itemChange.value = change.toFixed(2);
				} else {
					modalTitle.textContent = "新增改动项";
					itemId.value = "";
					form.reset();
				}
				modal.classList.remove("hidden");
				// 自动聚焦到第一个输入框
				setTimeout(() => itemName.focus(), 100);
			}

			/**
			 * 关闭模态框
			 */
			function closeModal() {
				modal.classList.add("hidden");
				form.reset();
			}

			// --- 初始化 ---
			document.addEventListener("DOMContentLoaded", fetchItems);

			// 覆盖 window.confirm，避免 iframe 弹出原生对话框
			window.confirm = (message) => {
				return window.prompt(message + " (输入 '确定' 以继续)") === "确定";
			};
		</script>
	</body>
</html>
