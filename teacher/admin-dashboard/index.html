<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1, minimum-scale=1" />
		<title>班级管理面板（管理员）</title>
		<!-- 载入 Bootstrap 5 CSS -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
		<!-- 载入 Bootstrap Icons -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

		<style>
			/* --- 触控与缩放限制 (保持一致) --- */
			html {
				touch-action: none;
				-ms-text-size-adjust: 100%;
				-moz-text-size-adjust: 100%;
				-webkit-text-size-adjust: 100%;
				zoom: 1;
			}

			/* --- 自定义样式 --- */
			body {
				background-color: #f8f9fa;
				font-family: "Inter", sans-serif;
			}

			/* --- 动画样式 (复用 index.html 逻辑) --- */
			.tab-pane-fade {
				display: none;
				opacity: 0;
				transition: opacity 0.1s ease-in-out;
			}
			.tab-pane-fade.active-block {
				display: block;
			}
			.tab-pane-fade.show {
				opacity: 1;
			}

			/* 修正 Accordion 圆角 */
			.accordion-body .list-group-item:first-child {
				border-top-left-radius: 0;
				border-top-right-radius: 0;
			}
			.accordion-body .list-group-item:last-child {
				border-bottom-left-radius: 0;
				border-bottom-right-radius: 0;
			}

			/* iframe 样式 */
			iframe {
				width: 100%;
				border: none;
				height: calc(100vh - 200px);
				min-height: 500px;
			}
		</style>
	</head>
	<body class="min-vh-100 d-flex flex-column">
		<!-- 会话过期提示模态框 (Bootstrap Modal) -->
		<div class="modal fade" id="session-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="sessionModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header border-bottom-0 pb-0">
						<h5 class="modal-title text-danger fw-bold" id="sessionModalLabel">会话过期通知</h5>
					</div>
					<div class="modal-body text-secondary">
						<p>登录已过期，请重新登录！</p>
					</div>
					<div class="modal-footer border-top-0 pt-0">
						<button id="modal-confirm-btn" type="button" class="btn btn-primary w-100">了解</button>
					</div>
				</div>
			</div>
		</div>

		<!-- 主面板容器 -->
		<div class="container py-4">
			<!-- 标题区块 -->
			<header class="mb-4 border-bottom pb-3">
				<h1 class="display-6 fw-bold text-dark">班级平台 管理员面板</h1>
				<p class="text-muted mt-1">在此管理班级平台的所有核心数据和功能。</p>
			</header>

			<!-- 栅格布局 -->
			<div class="row g-4">
				<!-- 侧边栏导航 (Accordion Sidebar) -->
				<div class="col-md-3">
					<!-- 创建一个 Sticky 包装器，包含“返回主页”和“菜单” -->
					<div class="sticky-top" style="top: 20px; z-index: 100">
						<!-- 独立模块：返回主页 -->
						<div class="card shadow-sm border-0 mb-3">
							<div class="list-group list-group-flush rounded-3">
								<button class="list-group-item list-group-item-action py-3 border-0 text-primary fw-bold d-flex align-items-center" onclick="location.href='/teacher/index.html'">
									<i class="bi bi-arrow-left-circle-fill me-2 fs-5"></i>
									<span>返回主页</span>
								</button>
							</div>
						</div>

						<!-- 主要功能菜单 (Accordion) -->
						<div class="accordion shadow-sm" id="sidebarAccordion">
							<!-- 分组 1: 概览 -->
							<div class="accordion-item">
								<h2 class="accordion-header" id="headingOne">
									<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">概览</button>
								</h2>
								<div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#sidebarAccordion">
									<div class="accordion-body p-0">
										<div class="list-group list-group-flush">
											<!-- 仪表盘 -->
											<button class="list-group-item list-group-item-action py-3 border-0 active" onclick="showTab('dashboard')" data-tab="dashboard">仪表盘</button>
										</div>
									</div>
								</div>
							</div>

							<!-- 分组 2: 人员与组织 -->
							<div class="accordion-item">
								<h2 class="accordion-header" id="headingTwo">
									<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">人员管理</button>
								</h2>
								<div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#sidebarAccordion">
									<div class="accordion-body p-0">
										<div class="list-group list-group-flush">
											<button class="list-group-item list-group-item-action py-3 border-0" onclick="showTab('students')" data-tab="students">学生管理</button>
											<button class="list-group-item list-group-item-action py-3 border-0" onclick="showTab('groups')" data-tab="groups">小组管理</button>
											<button class="list-group-item list-group-item-action py-3 border-0" onclick="showTab('teachers')" data-tab="teachers">教师管理</button>
										</div>
									</div>
								</div>
							</div>

							<!-- 分组 3: 评分与作业 -->
							<div class="accordion-item">
								<h2 class="accordion-header" id="headingThree">
									<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">教务功能</button>
								</h2>
								<div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#sidebarAccordion">
									<div class="accordion-body p-0">
										<div class="list-group list-group-flush">
											<button class="list-group-item list-group-item-action py-3 border-0" onclick="showTab('scorechangelog')" data-tab="scorechangelog">量化评分变动记录</button>
											<button class="list-group-item list-group-item-action py-3 border-0" onclick="showTab('scorechangetype')" data-tab="scorechangetype">量化评分变动类别</button>
											<button class="list-group-item list-group-item-action py-3 border-0" onclick="showTab('homework-management')" data-tab="homework-management">作业管理</button>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- 内容区块 (Main Content) -->
				<div class="col-md-9">
					<div class="card shadow border-0 min-vh-75">
						<div class="card-body p-0">
							<!-- 1. 仪表盘内容 -->
							<div id="dashboard" class="tab-pane-fade active-block show p-4">
								<h2 class="h3 fw-bold text-primary mb-3">仪表盘</h2>
								<div class="alert alert-primary border-0 bg-opacity-10" role="alert">
									<h4 class="alert-heading h5 fw-bold">欢迎来到管理员仪表盘！</h4>
									<p class="mb-0">此处应显示班级的关键数据摘要，例如活跃学生数、最近的评分活动和系统健康状态。</p>
								</div>
							</div>

							<!-- 2. 学生管理内容 -->
							<div id="students" class="tab-pane-fade">
								<iframe src="/teacher/admin-dashboard/students.html" id="students-iframe"></iframe>
							</div>

							<!-- 3. 小组管理内容 -->
							<div id="groups" class="tab-pane-fade">
								<iframe src="/teacher/admin-dashboard/groups.html" id="groups-iframe"></iframe>
							</div>

							<!-- 4. 教师管理内容 -->
							<div id="teachers" class="tab-pane-fade">
								<iframe src="/teacher/admin-dashboard/teachers.html" id="teachers-iframe"></iframe>
							</div>

							<!-- 5. 量化评分变动记录内容 -->
							<div id="scorechangelog" class="tab-pane-fade">
								<iframe src="/teacher/admin-dashboard/scorechangelog.html" id="scorechangelog-iframe"></iframe>
							</div>

							<!-- 6. 量化评分变动类别内容 -->
							<div id="scorechangetype" class="tab-pane-fade">
								<iframe src="/teacher/admin-dashboard/scorechangetype.html" id="scorechangetype-iframe"></iframe>
							</div>

							<!-- 7. 作业管理 -->
							<div id="homework-management" class="tab-pane-fade">
								<iframe src="/teacher/admin-dashboard/homework.html" id="homework-management-iframe"></iframe>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- 载入 Bootstrap 5 JS Bundle -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<!-- 载入 Cookies 库 -->
		<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

		<script>
			// --- 全局配置 (保持管理员端特定的配置) ---
			const CHECK_INTERVAL = 10000;
			// 注意：这里保留了管理员/教师端的检查接口
			const SESSION_CHECK_URL = "/system/teacher-profile.php";
			// 注意：这里保留了管理员/教师端的登录页
			const LOGIN_URL = "/teacher/login.html";

			let sessionInterval;
			let isAnimating = false;

			// --- 模态框处理 (Bootstrap 方式) ---
			function showSessionExpiredModal() {
				const modalElement = document.getElementById("session-modal");
				const modal = new bootstrap.Modal(modalElement);
				modal.show();
			}

			function handleModalConfirm() {
				clearInterval(sessionInterval);
				window.location.href = LOGIN_URL;
			}

			// --- 核心：切换分页内容 (带 0.1s 动画，与 index.html 一致) ---
			function showTab(tabId) {
				const targetContent = document.getElementById(tabId);
				// 如果正在动画中或点击的是当前已显示的 Tab，则忽略
				if (isAnimating || (targetContent && targetContent.classList.contains("show"))) return;

				// 1. 更新侧边栏按钮状态 (移除旧的 active，添加新的 active)
				document.querySelectorAll(".list-group-item").forEach((btn) => {
					btn.classList.remove("active");
				});
				// 查找并激活对应的按钮（如果存在）
				const selectedButton = document.querySelector(`.list-group-item[data-tab='${tabId}']`);
				if (selectedButton) {
					selectedButton.classList.add("active");
				}

				// 2. 动画切换逻辑
				const currentContent = document.querySelector(".tab-pane-fade.show");

				if (currentContent) {
					isAnimating = true;

					// 第一步：淡出
					currentContent.classList.remove("show");

					setTimeout(() => {
						// 第二步：隐藏旧元素
						currentContent.classList.remove("active-block");

						if (targetContent) {
							// 第三步：显示新元素 (display: block)
							targetContent.classList.add("active-block");

							// 强制重排
							void targetContent.offsetWidth;

							// 第四步：淡入
							targetContent.classList.add("show");
						}

						setTimeout(() => {
							isAnimating = false;
						}, 100);
					}, 100);
				} else {
					// 初始载入
					if (targetContent) {
						targetContent.classList.add("active-block", "show");
					}
				}
			}

			// --- 会话检查逻辑 ---
			async function attemptSessionCheck() {
				try {
					const response = await fetch(SESSION_CHECK_URL, { method: "GET", cache: "no-store" });
					if (response.status === 200 || response.status === 500) return true;
					else return false;
				} catch (error) {
					return false;
				}
			}

			async function checkSession() {
				const firstAttemptSuccess = await attemptSessionCheck();
				if (firstAttemptSuccess) return;

				await new Promise((resolve) => setTimeout(resolve, 1000));

				const secondAttemptSuccess = await attemptSessionCheck();
				if (secondAttemptSuccess) return;

				clearInterval(sessionInterval);
				showSessionExpiredModal();
			}

			document.addEventListener("DOMContentLoaded", () => {
				// 1. 初始 Cookie 检查 (管理员端检查 'token')
				if (Cookies.get("token") === undefined) {
					window.location.href = LOGIN_URL;
					return;
				}

				// 2. 预设显示仪表盘
				showTab("dashboard");

				// 3. 启动会话检查
				checkSession();
				sessionInterval = setInterval(checkSession, CHECK_INTERVAL);

				// 4. 绑定模态框按钮
				document.getElementById("modal-confirm-btn").addEventListener("click", handleModalConfirm);
			});
		</script>
	</body>
</html>
