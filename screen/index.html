<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1, minimum-scale=1" />
		<title>班级管理面板</title>
		<!-- 载入 Bootstrap 5 CSS -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

		<style>
			/* --- 保留原有的触控与缩放限制 --- */
			html {
				touch-action: none; /* 禁止双击放大 */
				-ms-text-size-adjust: 100%; /* IE10 以下禁止用户调整文本大小 */
				-moz-text-size-adjust: 100%; /* 火狐浏览器禁止用户调整文本大小 */
				-webkit-text-size-adjust: 100%; /* Safari 和 Chrome 禁止用户调整文本大小 */
				zoom: 1; /* 禁止用户缩放 */
			}

			/* --- 自定义样式 --- */
			body {
				background-color: #f8f9fa;
			}

			/* --- 动画样式 --- */
			/* 基础 Tab 状态：隐藏且透明 */
			.tab-pane-fade {
				display: none;
				opacity: 0;
				transition: opacity 0.1s ease-in-out; /* 0.1秒渐变动画 */
			}
			/* 显示状态：占据空间 (block) */
			.tab-pane-fade.active-block {
				display: block;
			}
			/* 可见状态：完全不透明 (opacity 1) */
			.tab-pane-fade.show {
				opacity: 1;
			}

			/* 修正 Accordion 内 list-group 的圆角问题 */
			.accordion-body .list-group-item:first-child {
				border-top-left-radius: 0;
				border-top-right-radius: 0;
			}
			.accordion-body .list-group-item:last-child {
				border-bottom-left-radius: 0;
				border-bottom-right-radius: 0;
			}
			/* 确保 iframe 在内容区块中能完全填满 */
			iframe {
				width: 100%;
				border: none;
				/* 设置一个响应式高度，确保内容可见 */
				height: calc(100vh - 200px);
				min-height: 500px;
			}
		</style>
	</head>
	<body class="min-vh-100 d-flex flex-column">
		<!-- 会话过期提示模态框 (Bootstrap Modal) -->
		<div class="modal fade" id="session-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="sessionModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header border-bottom-0 pb-0">
						<h5 class="modal-title text-danger fw-bold" id="sessionModalLabel">会话过期通知</h5>
					</div>
					<div class="modal-body text-secondary">
						<p>登录已过期，请重新登录！</p>
					</div>
					<div class="modal-footer border-top-0 pt-0">
						<button id="modal-confirm-btn" type="button" class="btn btn-primary w-100">了解</button>
					</div>
				</div>
			</div>
		</div>

		<!-- 主面板容器 -->
		<div class="container py-4">
			<!-- 标题区块 -->
			<header class="mb-4 border-bottom pb-3">
				<h1 class="display-6 fw-bold text-dark">班级大屏</h1>
				<p class="text-muted mt-1">在此查看今日情况并提交作业。</p>
			</header>

			<!-- 栅格布局 -->
			<div class="row g-4">
				<!-- 侧边栏导航 (Accordion Sidebar) -->
				<div class="col-md-3">
					<!-- 使用 Accordion 组件 -->
					<div class="accordion shadow-sm sticky-top" id="sidebarAccordion" style="top: 20px; z-index: 100">
						<!-- 分组 1: 概览 -->
						<div class="accordion-item">
							<h2 class="accordion-header" id="headingOne">
								<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">概览</button>
							</h2>
							<div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#sidebarAccordion">
								<div class="accordion-body p-0">
									<div class="list-group list-group-flush">
										<button class="list-group-item list-group-item-action py-3 border-0 active" onclick="showTab('dashboard')" data-tab="dashboard">仪表盘</button>
									</div>
								</div>
							</div>
						</div>

						<!-- 分组 2: 功能 -->
						<div class="accordion-item">
							<h2 class="accordion-header" id="headingTwo">
								<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">功能</button>
							</h2>
							<div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#sidebarAccordion">
								<div class="accordion-body p-0">
									<div class="list-group list-group-flush">
										<button class="list-group-item list-group-item-action py-3 border-0" onclick="showTab('homework')" data-tab="homework">作业提交</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- 内容区块 (Main Content) -->
				<div class="col-md-9">
					<div class="card shadow border-0 min-vh-75">
						<div class="card-body p-0">
							<!-- 1. 仪表板内容 (注意：移除了 bootstrap 原生 tab-pane 类，使用自定义 tab-pane-fade 以控制动画) -->
							<div id="dashboard" class="tab-pane-fade active-block show p-4">
								<h2 class="h3 fw-bold text-primary mb-3">仪表盘</h2>
								<div class="alert alert-primary border-0 bg-opacity-10" role="alert">
									<h4 class="alert-heading h5 fw-bold">欢迎来到管理员仪表盘！</h4>
									<p class="mb-0">此处应显示班级的关键数据摘要，例如活跃学生数、最近的评分活动和系统健康状态。</p>
								</div>
							</div>

							<!-- 2. 作业提交内容 (iframe) -->
							<div id="homework" class="tab-pane-fade">
								<iframe src="/screen/homework.html" id="homework-iframe"></iframe>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- 载入 Bootstrap 5 JS Bundle -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<!-- 载入 Cookies 库 -->
		<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

		<script>
			const CHECK_INTERVAL = 10000;
			const SESSION_CHECK_URL = "/system/screen-profile.php";
			const LOGIN_URL = "/screen/login.html";
			let sessionInterval;
			let isAnimating = false; // 防止快速点击导致动画冲突

			// --- 模态框处理 ---
			function showSessionExpiredModal() {
				const modalElement = document.getElementById("session-modal");
				const modal = new bootstrap.Modal(modalElement);
				modal.show();
			}

			function handleModalConfirm() {
				clearInterval(sessionInterval);
				window.location.href = LOGIN_URL;
			}

			// --- 核心：切换分页内容 (带 0.1s 动画) ---
			function showTab(tabId) {
				// 如果正在动画中或点击的是当前已显示的 Tab，则忽略
				const targetContent = document.getElementById(tabId);
				if (isAnimating || (targetContent && targetContent.classList.contains("show"))) return;

				// 1. 更新侧边栏按钮状态
				document.querySelectorAll(".list-group-item").forEach((btn) => {
					btn.classList.remove("active");
				});
				const selectedButton = document.querySelector(`.list-group-item[data-tab='${tabId}']`);
				if (selectedButton) {
					selectedButton.classList.add("active");
				}

				// 2. 动画切换逻辑
				const currentContent = document.querySelector(".tab-pane-fade.show");

				if (currentContent) {
					isAnimating = true;

					// 第一步：淡出 (Opacity -> 0)
					currentContent.classList.remove("show");

					// 等待 0.1s 动画结束
					setTimeout(() => {
						// 第二步：隐藏旧元素 (display: none)
						currentContent.classList.remove("active-block");

						if (targetContent) {
							// 第三步：显示新元素 (display: block)，此时 opacity 仍为 0
							targetContent.classList.add("active-block");

							// 强制浏览器重排 (Reflow)，确保 opacity transition 生效
							void targetContent.offsetWidth;

							// 第四步：淡入 (Opacity -> 1)
							targetContent.classList.add("show");
						}

						// 动画结束，解锁
						// 稍微多给一点时间缓冲，防止边缘情况
						setTimeout(() => {
							isAnimating = false;
						}, 100);
					}, 100); // 这里的 100ms 对应 CSS 中的 transition 0.1s
				} else {
					// 如果没有当前显示的内容（页面初始化），直接显示
					if (targetContent) {
						targetContent.classList.add("active-block", "show");
					}
				}
			}

			// --- 会话检查逻辑 ---
			async function attemptSessionCheck() {
				try {
					const response = await fetch(SESSION_CHECK_URL, { method: "GET", cache: "no-store" });
					if (response.status === 200 || response.status === 500) return true;
					else return false;
				} catch (error) {
					return false;
				}
			}

			async function checkSession() {
				const firstAttemptSuccess = await attemptSessionCheck();
				if (firstAttemptSuccess) return;
				await new Promise((resolve) => setTimeout(resolve, 1000));
				const secondAttemptSuccess = await attemptSessionCheck();
				if (secondAttemptSuccess) return;
				clearInterval(sessionInterval);
				showSessionExpiredModal();
			}

			document.addEventListener("DOMContentLoaded", () => {
				// 初始 Cookie 检查
				if (Cookies.get("screen_token") === undefined) {
					window.location.href = LOGIN_URL;
					return;
				}
				// 启动会话检查
				checkSession();
				sessionInterval = setInterval(checkSession, CHECK_INTERVAL);
				// 绑定模态框按钮
				document.getElementById("modal-confirm-btn").addEventListener("click", handleModalConfirm);
			});
		</script>
	</body>
</html>
